<html>
<head>
    <title>Angular 2 QuickStart</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natia</title>
    <!-- Bootstrap styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="css/jquery.fileupload.css">
    <!-- jQuery UI style -->
    <!--<link rel="stylesheet" href="css/jquery-ui.css">-->
    <!-- Generic page styles -->
    <link rel="stylesheet" href="css/style.css">

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="js/jquery.fileupload.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-xl-12">
                <div id="tab-titles">
                    <ul id="myTab" class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#order-tab">Orders</a></li>
                        <li><a data-toggle="tab" href="#rules-tab">Rules</a></li>
                        <li><a data-toggle="tab" href="#catalogue-tab">Product list</a></li>
                    </ul>
                </div>

                <div class="vspace"></div>

                <div id="error-display"></div>

                <div class="tab-content">
                    <!-- O R D E  R S -->
                    <div id="order-tab" class="tab-pane fade in active">
                        <p>Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. </p>
                    </div>

                    <!-- R U L E S -->
                    <div id="rules-tab" class="tab-pane fade">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button id="create-rule-btn" type="button" class="btn btn-success">
                                            <span class="glyphicon glyphicon-plus"></span>
                                            New
                                        </button>
                                    </span>
                                    <input id="new-rule-name-inp" type="text" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-9">
                                Rule detail buttons here
                            </div>
                        </div>
                        <div class="vspace"></div>
                        <div class="row vertical-space">
                            <div class="col-md-3">
                                <ul id="rule-list" class="list-group"></ul>
                            </div>
                            <div class="col-md-9">
                                Rule detail here
                            </div>
                        </div>
                    </div>

                    <!-- C A T A L O G U E -->
                    <div id="catalogue-tab" class="tab-pane fade">
                        <span class="btn btn-success fileinput-button">
                            <i class="glyphicon glyphicon-upload"></i>
                            <span>Upload product list</span>
                            <input id="fileupload" type="file" name="file" data-url="/api/v1/catalogue">
                        </span>
                        <div class="vspace"></div>
                        <div id="progress" class="progress">
                            <div class="progress-bar progress-bar-success"></div>
                        </div>
                        <div id="successdiv" class="ui-widget" style="display: none">
                            <div class="ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;">
                                <p>
                                    <span class="ui-icon ui-icon-check" style="float: left; margin-right: .3em;"></span>
                                    <span id="success-msg"></span>
                                </p>
                            </div>
                        </div>
                        <div id="errordiv" class="ui-widget" style="display: none">
                            <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;">
                                <p>
                                    <span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
                                    <span id="error-msg"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message dialog -->
<div id="dialog-message" title="">
    <p></p>
</div>

<script>
    $(function () {
        $('#create-rule-btn')
                .prop('disabled',true)
                .click(function() {
                    createRule($('#new-rule-name-inp').val());
                });

        $('#new-rule-name-inp')
                .keyup(function(){
                    $('#create-rule-btn').prop('disabled', this.value == "" ? true : false);
                });

        $( "#rule-list" )
                .sortable({
                    handle:".handle",
                    update: function( event, ui ) {
                        var newIndex = ui.item.index();
                        var id = $(ui.item).attr("ruleid");
                        setRuleRank(id, newIndex);
                    }
                });

        $('#fileupload').fileupload({
            dataType: 'json',
            submit: function() {
                $('#errordiv').hide();
                $('#successdiv').hide();
                $('#error-msg').text('');
                $('#success-msg').text('');
            },
            done: function (e, data) {
                $('#success-msg').text('Načteno ' + data.result.numberOfArticlesImported + ' položek katalogu.');
                $('#successdiv').show();
                $('#progress .progress-bar').css('width', '0%');
            },
            fail: function (e, data) {
                $('#error-msg').text('Došlo k chybě. Katalog nebyl načten.');
                $('#errordiv').show();
                $('#progress .progress-bar').css('width', '0%');
            },
            progress: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress .progress-bar').css('width', progress + '%');
            }
        }).prop('disabled', !$.support.fileInput)
                .parent().addClass($.support.fileInput ? undefined : 'disabled');
    });

    function setRuleRank(id, rank) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/' + id + '/rank/' + rank,
            contentType: 'application/json; charset=utf-8',
            data: null,
            error: function ($xhr) {
                $('#dialog-message').attr({"title":"Chyba!"});
                $('#dialog-message > p').text($xhr.responseJSON[0].desc);
                $('#dialog-message').dialog('open');
                loadRules()
            }
        });
    }

    function loadRules() {
        $.ajax({
            type: 'GET',
            url: '/api/v1/rules',
            dataType: 'json',
            success: function (data) {
                $('#rule-list').html('');
                data.forEach(function(rule) {
                    var deleteBtnId = '#btnDeleteRule' + rule.id;
                    $('#rule-list').append('<li id="itemRule' + rule.id + '" ruleId="' + rule.id + '" class="list-group-item"><span class="handle"><span class="glyphicon glyphicon-resize-vertical"></span></span>' + rule.name +
                            '<span id="' + deleteBtnId + '" class="btn btn-danger btn-xs remove-button glyphicon glyphicon-remove" onclick="deleteRule(' + rule.id + ')"></span></li>')
                    $(deleteBtnId).click(function(e) {
                        deleteRule(rule.id);
                    })
                })
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
            }
        });
    }

    function createRule(ruleName) {
        $.ajax({
            type: 'POST',
            url: '/api/v1/rules',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({'name': ruleName}),
            success: function(data) {
                $('#new-rule-name-inp').val('');
                loadRules();
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRules();
            }
        });
    }

    function getErrorText($xhr) {
        if ($xhr.responseJSON != undefined && $xhr.responseJSON.length > 0 && $xhr.responseJSON[0].desc != undefined) {
            return $xhr.responseJSON[0].desc;
        }
        return $xhr.status + ' : ' + $xhr.statusText;
    }

    function displayError(message) {
        var element = $('<div class="alert alert-danger"><strong>ERROR!</strong> ' + message + '</div>');
        element.hide();
        $('#error-display').append(element);
        element.show(100);
        setTimeout(function() {
                element.hide(500)
            }, 5000);
    }

    function renameRule(id, ruleName) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/' + id,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({'name': ruleName}),
            success: function(data) {
                loadRules();
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRules();
            }
        });
    }

    function deleteRule(id) {
        $.ajax({
            type: 'DELETE',
            url: '/api/v1/rules/' + id,
            success: function(data) {
                loadRules();
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRules();
            }
        });
    }

    loadRules();
</script>
</body>
</html>