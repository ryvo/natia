<html>
<head>
    <title>Angular 2 QuickStart</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natia</title>
    <!-- Bootstrap styles -->
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/bootstrap-editable.css">
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="css/jquery.fileupload.css">
    <!-- jQuery UI style -->
    <!--<link rel="stylesheet" href="css/jquery-ui.css">-->
    <!-- Generic page styles -->
    <link rel="stylesheet" href="css/style.css">

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/bootstrap-editable.js"></script>
    <script src="js/typeahead.bundle.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="js/jquery.fileupload.js"></script>
    <!--<script src="js/jquery.fileDownload.js"></script>-->
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-xl-12">
                <div id="tab-titles">
                    <ul id="myTab" class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#order-tab">Orders</a></li>
                        <li><a data-toggle="tab" href="#rules-tab">Rules</a></li>
                        <li><a data-toggle="tab" href="#catalogue-tab">Product list</a></li>
                    </ul>
                </div>

                <div class="vspace"></div>

                <div id="message-display"></div>

                <div class="tab-content">
                    <!-- O R D E  R S -->
                    <div id="order-tab" class="tab-pane fade in active">
                        <span class="btn btn-success fileinput-button">
                            <i class="glyphicon glyphicon-upload"></i>
                            <span>Upload</span>
                            <input id="order-upload" type="file" name="file" data-url="/api/v1/orders">
                        </span>
                        <div class="vspace"></div>
                        <div id="order-processing-progress" class="progress" style="visibility: hidden">
                            <div class="progress-bar progress-bar-success"></div>
                        </div>
                        <div id="results" style="visibility: hidden">
                            <table id="results-table" class="table table-hover">
                                <thead>
                                    <th class="gift-code">Code</th>
                                    <th class="gift-description">Description</th>
                                    <th class="gift-amount">Pieces</th>
                                </thead>
                                <tbody>
                                    <td colspan="3"><i>No results</i></td>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- R U L E S -->
                    <div id="rules-tab" class="tab-pane fade">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button id="create-rule-btn" type="button" class="btn btn-success">
                                            <span class="glyphicon glyphicon-plus"></span>
                                            New
                                        </button>
                                    </span>
                                    <input id="new-rule-name-inp" type="text" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button id="add-input-product-btn" type="button" class="btn btn-success">
                                            Add required product
                                            <span class="glyphicon glyphicon-arrow-down"></span>
                                        </button>
                                    </span>
                                    <input id="product-inp" type="text" class="form-control" autocomplete="off" spellcheck="false">
                                    <span class="input-group-btn">
                                        <button id="add-output-product-btn" type="button" class="btn btn-success">
                                            <span class="glyphicon glyphicon-arrow-down"></span>
                                            Add gift product
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="vspace"></div>

                        <div id="rule-details" class="row vertical-space">
                            <div class="col-md-3">
                                <ul id="rule-list" class="list-group"></ul>
                            </div>
                            <div class="col-md-9">
                                <div class="col-md-6 required-products-column">
                                    <ul id="required-product-list" class="list-group"></ul>
                                </div>
                                <div class="col-md-6 gift-products-column">
                                    <ul id="gift-product-list" class="list-group"></ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- C A T A L O G U E -->
                    <div id="catalogue-tab" class="tab-pane fade">
                        <span class="btn btn-primary fileinput-button">
                            <i class="glyphicon glyphicon-upload"></i>
                            <span>Upload</span>
                            <input id="catalogue-upload" type="file" name="file" data-url="/api/v1/catalogue">
                        </span>
                        <div class="vspace"></div>
                        <div id="catalogue-upload-progress" class="progress" style="visibility: hidden">
                            <div class="progress-bar progress-bar-success"></div>
                        </div>
                        <div class="panel panel-info">
                            <div class="panel-heading"><strong>Catalogue information</strong></div>
                            <div id="catalogue-info" class="panel-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message dialog -->
<div id="dialog-message" title="">
    <p></p>
</div>

<script>
    // setting defaults for the editable
    $.fn.editable.defaults.mode = 'inline';
    $.fn.editable.defaults.showbuttons = false;

    selectedRuleId = null;

    $(function () {
        $('.editable').editable();

        $('#create-rule-btn')
                .prop('disabled',true)
                .click(function() {
                    createRule($('#new-rule-name-inp').val());
                });

        $('#new-rule-name-inp')
                .on('input', function(){
                    $('#create-rule-btn').prop('disabled', this.value == "" ? true : false);
                });

        $( "#rule-list" )
                .sortable({
                    handle:".handle",
                    update: function( event, ui ) {
                        var newIndex = ui.item.index();
                        var id = $(ui.item).attr("ruleid");
                        setRuleRank(id, newIndex);
                    }
                });

        $('#add-input-product-btn')
                .prop('disabled', true)
                .click(function() {
                    addRequiredProduct(selectedRuleId, $('#product-inp').val());
                });

        $('#add-output-product-btn')
                .prop('disabled', true)
                .click(function() {
                    addGiftProduct(selectedRuleId, $('#product-inp').val());
                });

        $('#product-inp')
                .on('input', function(){
                    var disabled = this.value == "";
                    $('#add-input-product-btn').prop('disabled', disabled);
                    $('#add-output-product-btn').prop('disabled', disabled);
                })

        $('#catalogue-upload').fileupload({
            dataType: 'json',
            pasteZone: null,
            submit: function() {
                $('#catalogue-upload-progress > .progress-bar').css('width', '0%');
                $('#catalogue-upload-progress').css('visibility', 'visible');
            },
            success: function (result, textStatus, jqXHRa) {
                var message = result.numberOfArticlesImported + ' products were successfuly loaded.';
                loadCatalogueInfo();
                displaySuccess(message);
                $('#catalogue-upload-progress').css('visibility', 'hidden');
            },
            error: function (jqXHR, textStatus, errorThrown) {
                loadCatalogueInfo();
                displayError(getErrorText(jqXHR));
                $('#catalogue-upload-progress').css('visibility', 'hidden');
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#catalogue-upload-progress > .progress-bar').css('width', progress + '%');
            }
        }).prop('disabled', !$.support.fileInput)
            .parent().addClass($.support.fileInput ? undefined : 'disabled');

        $('#order-upload').fileupload({
            pasteZone: null,
            submit: function() {
                $('#results').css('visibility', 'hidden');
                $('#results-table tbody').empty();
                $('#order-upload-progress > .progress-bar').css('width', '0%');
                $('#order-processing-progress').css('visibility', 'visible');
            },
            success: function (data) {
                var i = 0;
                data.forEach(function(gift) {
                    var giftId = 'gift-' + i;
                    var giftRulesId = 'gift-rules-' + i;
                    gitem = $('<tr data-toggle="collapse" data-target="#' + giftId + '" class="clickable">' +
                            '  <td class="gift-code">' + gift.code + '</td>' +
                            '  <td class="gift-description">' + gift.description + '</td>' +
                            '  <td class="gift-amount">' + gift.amount + '</td>' +
                            '</tr>' +
                            '<tr id="' + giftId + '" class="collapse">' +
                            '  <td colspan="3" class="gift-rule-cell">' +
                            '  <div>' +
                            '    <table id="' + giftRulesId + '" class="table table-bordered gift-rule-table">' +
                            '      <thead><th class="gift-rule-table-rule-name">Rule name</th><th class="gift-rule-table-rule-pieces">Pieces</th></thead>' +
                            '    </table>' +
                            '  </div>' +
                            '  </td>' +
                            '</tr>');

                    gift.rules.forEach(function(rule) {
                        ritem = $('<tr><td class="gift-rule-table-rule-name">' + rule.name + '</td><td class="gift-rule-table-rule-pieces">' + rule.amount + '</td></tr>');
                        gitem.find('#' + giftRulesId).append(ritem);
                    });

                    $('#results-table').append(gitem);

                    i++;
                });
                $('#order-processing-progress').css('visibility', 'hidden');
                $('#results').css('visibility', 'visible');
            },
            error: function (jqXHR, textStatus, errorThrown) {
                displayError(getErrorText(jqXHR));
                $('#order-processing-progress').css('visibility', 'hidden');
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#order-upload-progress > .progress-bar').css('width', progress + '%');
            }
        }).prop('disabled', !$.support.fileInput)
                .parent().addClass($.support.fileInput ? undefined : 'disabled');

        disableTypeahead();
    });

    function setRuleRank(id, rank) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/' + id + '/rank/' + rank,
            contentType: 'application/json; charset=utf-8',
            data: null,
            error: function ($xhr) {
                $('#dialog-message').attr({"title":"Chyba!"});
                $('#dialog-message > p').text($xhr.responseJSON[0].desc);
                $('#dialog-message').dialog('open');
                loadRules()
            }
        });
    }

    function loadRules() {
        selectRule(null);
        $.ajax({
            type: 'GET',
            url: '/api/v1/rules',
            dataType: 'json',
            success: function (data) {
                $('#rule-list').html('');
                data.forEach(function(rule) {
                    var item = $(
                            '<li ruleId="' + rule.id + '" class="rule-item list-group-item"> ' +
                            '  <span class="handle">' +
                            '    <span class="glyphicon glyphicon-resize-vertical"></span>' +
                            '  </span>' +
                            '  <span class="editable">' + rule.name + '</span>' +
                            '  <span class="btn btn-danger btn-xs remove-button glyphicon glyphicon-remove"></span>' +
                            '</li>'
                        )
                        .click(function (e) {
                            selectRule(rule.id);
                        });
                    $('#rule-list').append(item)
                    if(selectedRuleId == rule.id) {
                        selectRule(rule.id);
                    }
                    item.find('.editable').editable()
                            .on('save', function (e, params) {
                                renameRule(rule.id, params.newValue);
                            });
                    item.find('.remove-button')
                            .on('click', function (e) {
                                e.stopPropagation();
                                deleteRule(rule.id);
                            });
                })
                loadRequiredProducts(selectedRuleId);
                loadGiftProducts(selectedRuleId);
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
            }
        });
    }

    function loadRequiredProducts(ruleId) {
        $('#required-product-list').empty();
        if (!ruleId) {
            return;
        }
        $.ajax({
            type: 'GET',
            url: '/api/v1/rules/' + ruleId + '/required-articles',
            dataType: 'json',
            success: function(data) {
                data.forEach(function(article) {
                    var item = $(
                            '<li ruleId="' + ruleId + '" articleId="' + article.id + '" class="rule-item list-group-item"> ' +
                            '  <table><tr>' +
                            '    <td class="article-delete-btn"><div class="article-delete-btn btn btn-danger btn-xs remove-button glyphicon glyphicon-remove"></div></td>' +
                            '    <td class="article-code"><strong>' + article.code + '</strong></i></td>' +
                            '    <td class="article-amount"><span class="editable"><strong>' + article.amount + '</strong></span></td>' +
                            '  </tr><tr>' +
                            '    <td class="article-delete-btn"></td>' +
                            '    <td class="article-code"><i>' + article.description + '</i></td>' +
                            '    <td class="article-amount"></td>' +
                            '  </tr></table>' +
                            '</li>'
                    ).appendTo($('#required-product-list'));

                    if (article.inCatalogue == false) {
                        item.addClass("rule-article-not-in-catalogue");
                    }

                    item.find('.editable').editable({clear:false})
                        .on('shown', function(e, editable) {
                            setTimeout(function() {
                                editable.input.$input.select();
                            }, 0);
                        })
                        .on('save', function (e, params) {
                            updateRequiredArticleAmount(article.id, params.newValue);
                        });

                    item.find('.article-delete-btn')
                        .on('click', function (e) {
                            e.stopPropagation();
                            deleteRequiredArticle(article.id);
                        });
                })
            },
            error: function(xhr) {
                displayError(getErrorText(xhr));
            }
        });
    }

    function loadGiftProducts(ruleId) {
        $('#gift-product-list').empty();
        if (!ruleId) {
            return;
        }
        $.ajax({
            type: 'GET',
            url: '/api/v1/rules/' + ruleId + '/gift-articles',
            dataType: 'json',
            success: function(data) {
                data.forEach(function(article) {
                    var item = $(
                            '<li ruleId="' + ruleId + '" articleId="' + article.id + '" class="rule-item list-group-item"> ' +
                            '  <table><tr>' +
                            '    <td class="article-delete-btn"><div class="article-delete-btn btn btn-danger btn-xs remove-button glyphicon glyphicon-remove"></div></td>' +
                            '    <td class="article-code"><strong>' + article.code + '</strong></i></td>' +
                            '    <td class="article-amount"><span class="editable"><strong>' + article.amount + '</strong></span></td>' +
                            '  </tr><tr>' +
                            '    <td class="article-delete-btn"></td>' +
                            '    <td class="article-code"><i>' + article.description + '</i></td>' +
                            '    <td class="article-amount"></td>' +
                            '  </tr></table>' +
                            '</li>'
                    ).appendTo($('#gift-product-list'));

                    if (article.inCatalogue == false) {
                        item.addClass("rule-article-not-in-catalogue");
                    }

                    item.find('.editable').editable({clear:false})
                            .on('shown', function(e, editable) {
                                setTimeout(function() {
                                    editable.input.$input.select();
                                }, 0);
                            })
                            .on('save', function (e, params) {
                                updateGiftArticleAmount(article.id, params.newValue);
                            });

                    item.find('.article-delete-btn')
                            .on('click', function (e) {
                                e.stopPropagation();
                                deleteGiftArticle(article.id);
                            });
                })
            },
            error: function(xhr) {
                displayError(getErrorText(xhr));
            }
        });
    }

    function createRule(ruleName) {
        $.ajax({
            type: 'POST',
            url: '/api/v1/rules',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({'name': ruleName}),
            success: function(data) {
                $('#new-rule-name-inp').val('');
                selectedRuleId = null;
                loadRules();
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRules();
            }
        });
    }

    function getErrorText($xhr) {
        if ($xhr.responseJSON != undefined && $xhr.responseJSON.length > 0 && $xhr.responseJSON[0].desc != undefined) {
            return $xhr.responseJSON[0].desc;
        }
        return $xhr.status + ' : ' + $xhr.statusText;
    }

    function displayError(message) {
        var element = $('<div class="alert alert-danger"><strong>ERROR!</strong> ' + message + '</div>');
        element.hide();
        $('#message-display').append(element);
        element.show(100);
        setTimeout(function() {
                element.hide(500)
            }, 5000);
    }

    function displaySuccess(message) {
        var element = $('<div class="alert alert-success"><strong>SUCCESS!</strong> ' + message + '</div>');
        element.hide();
        $('#message-display').append(element);
        element.show(100);
        setTimeout(function() {
            element.hide(500)
        }, 5000);
    }

    function renameRule(id, ruleName) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/' + id,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({'name': ruleName}),
            success: function(data) {
                loadRules();
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRules();
            }
        });
    }

    function deleteRule(id) {
        $.ajax({
            type: 'DELETE',
            url: '/api/v1/rules/' + id,
            success: function(data) {
                if(selectedRuleId == id) {
                    selectedRuleId = null;
                }
                loadRules();
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRules();
            }
        });
    }

    function addRequiredProduct(ruleId, code) {
        $.ajax({
            type: 'POST',
            url: '/api/v1/rules/' + ruleId + '/required-articles',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({'code': code, 'amount': 1}),
            success: function(data) {
                clearTypeahead();
                loadRequiredProducts(ruleId);
            },
            error: function(xhr) {
                displayError(getErrorText(xhr));
                loadRequiredProducts(ruleId);
            }
        });
    }


    function updateRequiredArticleAmount(id, amount) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/required-articles/' + id + '/amount/' + amount,
            success: function(data) {
                loadRequiredProducts(selectedRuleId);
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRequiredProducts(selectedRuleId);
            }
        });
    }

    function deleteRequiredArticle(id) {
        $.ajax({
            type: 'DELETE',
            url: '/api/v1/rules/required-articles/' + id,
            success: function(data) {
                loadRequiredProducts(selectedRuleId);
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadRequiredProducts(selectedRuleId);
            }
        });
    }

    function addGiftProduct(ruleId, code) {
        $.ajax({
            type: 'POST',
            url: '/api/v1/rules/' + ruleId + '/gift-articles',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({'code': code, 'amount': 1}),
            success: function(data) {
                clearTypeahead();
                loadGiftProducts(ruleId);
            },
            error: function(xhr) {
                displayError(getErrorText(xhr));
                loadGiftProducts(ruleId);
            }
        });
    }


    function updateGiftArticleAmount(id, amount) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/gift-articles/' + id + '/amount/' + amount,
            success: function(data) {
                loadGiftProducts(selectedRuleId);
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadGiftProducts(selectedRuleId);
            }
        });
    }

    function deleteGiftArticle(id) {
        $.ajax({
            type: 'DELETE',
            url: '/api/v1/rules/gift-articles/' + id,
            success: function(data) {
                loadGiftProducts(selectedRuleId);
            },
            error: function ($xhr) {
                displayError(getErrorText($xhr));
                loadGiftProducts(selectedRuleId);
            }
        });
    }

    function selectRule(id) {
        $('.rule-item:not([ruleId=' + id + '])').removeClass('selected-item');
        if(id) {
            selectedRuleId = id;
            loadRequiredProducts(id);
            loadGiftProducts(id);
            $('.rule-item[ruleId=' + id + ']').addClass('selected-item');

        } else {
            selectedRuleId = null;
        }
        var selectedItems = $('#rule-list').find('.rule-item.selected-item');
        var disabled = !selectedItems || selectedItems.length != 1;
        if (disabled) {
            disableTypeahead()
        } else {
            enableTypeahead();
        }
    }

    var bloodhound = new Bloodhound({
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        datumTokenizer: Bloodhound.tokenizers.whitespace,
        remote: {
            url: '/api/v1/catalogue/articles/search?pattern=%QUERY',
            wildcard: '%QUERY',
        },
    });

    function enableTypeahead() {
        $('#product-inp').prop('disabled', false);
        $('#product-inp').typeahead({
            hint: true,
            highlight: true,
            minLength: 4,
            display: function (data) {
                return data.name;
            }
        },{
            name: 'products',
            source: bloodhound,
            limit: 100,
            displayKey: 'code',
            templates: {
                suggestion: function(data){
                    return '<tr><td class="item-code">' + data.code + '</td><td class="item-name">' + data.name + '</td></tr>';
                }
            }
        });
    }

    function disableTypeahead() {
        $('#product-inp').prop('disabled', true);
        $('#product-inp').typeahead('destroy');
    }

    function clearTypeahead() {
        $('#product-inp').typeahead('val','');
        $('div#product-inp input').val('');
    }

    function loadCatalogueInfo() {
        $('#catalogue-info').empty();
        $.ajax({
            type: 'GET',
            url: '/api/v1/catalogue/info',
            success: function(data) {
                var info = '<table>' +
                    '<tr><td>Date and time of last import</td><td>:</td><td>' + data.dateAndTimeOfImport + '</td></tr>' +
                    '<tr><td>Number of items imported</td><td>:</td><td>' + data.numberOfImportedItems + '</td></tr>' +
                    '<tr><td>Filename of imported catalogue</td><td>:</td><td>' + data.fileName + '</td></tr>' +
                    '</<table>';
                $('#catalogue-info').html(info);
            },
            error: function(xhr) {
                displayError(getErrorText($xhr));
            }
        });

    }

    loadRules();
    loadCatalogueInfo();
</script>
</body>
</html>