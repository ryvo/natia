<html>
<head>
    <title>Angular 2 QuickStart</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natia</title>
    <!-- Bootstrap styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="css/jquery.fileupload.css">
    <!-- jQuery UI style -->
    <!--<link rel="stylesheet" href="css/jquery-ui.css">-->
    <!-- Generic page styles -->
    <link rel="stylesheet" href="css/style.css">

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="js/jquery.fileupload.js"></script>
</head>

<body>
<div class="container">
    <div class="row">
        <div class="col-xl-12">
            <div id="tabs">
                <ul id="myTab" class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#order-tab">Orders</a></li>
                    <li><a data-toggle="tab" href="#rules-tab">Rules</a></li>
                    <li><a data-toggle="tab" href="#catalogue-tab">Product list</a></li>
                </ul>

                <div class="tab-content">

                <div id="order-tab" class="tab-pane fade in active">
                    <p>Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. Objednávky. </p>
                </div>

                <!-- R U L E S -->
                <div id="rules-tab" class="tab-pane fade">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-btn">
                                    <button id="new-rule-dlg-btn" type="button" class="btn btn-success">
                                        <span class="glyphicon glyphicon-plus"></span>
                                        New
                                    </button>
                                </span>
                                <input type="text" class="form-control" placeholder="...">
                            </div>
                        </div>
                        <div class="col-md-9">
                            Rule detail buttons here
                        </div>
                    </div>
                    <div class="row vertical-space">
                        <div class="col-md-3">
                            <ul id="rule-list" class="list-group"></ul>
                        </div>
                        <div class="col-md-9">
                            Rule detail here
                        </div>
                    </div>
                </div>

                <!-- C A T A L O G U E -->
                <div id="catalogue-tab" class="tab-pane fade">
                    <span class="btn btn-success fileinput-button">
                        <i class="glyphicon glyphicon-upload"></i>
                        <span>Upload product list</span>
                        <input id="fileupload" type="file" name="file" data-url="/api/v1/catalogue">
                    </span>
                    <br/>
                    <br/>
                    <div id="progress" class="progress">
                        <div class="progress-bar progress-bar-success"></div>
                    </div>
                    <div id="successdiv" class="ui-widget" style="display: none">
                        <div class="ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;">
                            <p>
                                <span class="ui-icon ui-icon-check" style="float: left; margin-right: .3em;"></span>
                                <span id="success-msg"></span>
                            </p>
                        </div>
                    </div>
                    <div id="errordiv" class="ui-widget" style="display: none">
                        <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;">
                            <p>
                                <span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
                                <span id="error-msg"></span>
                            </p>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New rule dialogue -->
<div id="rule-dlg" title="Nové pravidlo">
    <input id="rule-name-inp" type="text" name="name">
</div>
<!-- Message dialog -->
<div id="dialog-message" title="">
    <p></p>
</div>

<script>
    $(function () {
        $('#rule-dlg').dialog({
            autoOpen: false,
            resizable: false,
            modal: true,
            buttons: {
                "Potvrdit": function() {
                    var mode = $(this).attr("mode");
                    if (mode == "create") {
                        createRule($('#rule-name-inp').val());
                    } else if (mode == "rename") {
                        var id = $("#rule-list").children(".ui-selected").attr('ruleId');
                        renameRule(id, $('#rule-name-inp').val())
                    }
                    $(this).dialog('close');
                },
                "Zrušit": function () {
                    $(this).dialog('close');
                }
            }
        });

        $('#new-rule-dlg-btn')
                .click(function() {
                    $('#rule-name-inp').val('');
                    $('#rule-dlg').attr("mode", "create");
                    $('#rule-dlg').dialog('open');
                });

        $('#rename-rule-dlg-btn')
                .click(function() {
                    var text = $("#rule-list").children(".ui-selected").text();
                    $('#rule-name-inp').val(text);
                    $('#rule-dlg').attr("mode", "rename");
                    $('#rule-dlg').dialog('open');
                });

        $('#delete-rule-dlg-btn')
                .click(function() {
                    var id = $("#rule-list").children(".ui-selected").attr('ruleId');
                    deleteRule(id);
                });

        $( "#dialog-message" ).dialog({
            autoOpen: false,
            modal: true,
            buttons: {
                'Potvrdit': function() {
                    $( this ).dialog( "close" );
                }
            }
        });

        $( "#rule-list" )
                .sortable({
                    handle:".handle",
                    update: function( event, ui ) {
                        var newIndex = ui.item.index();
                        var id = $(ui.item).attr("ruleid");
                        setRuleRank(id, newIndex);
                    }
                });

        $('#fileupload').fileupload({
            dataType: 'json',
            submit: function() {
                $('#errordiv').hide();
                $('#successdiv').hide();
                $('#error-msg').text('');
                $('#success-msg').text('');
            },
            done: function (e, data) {
                $('#success-msg').text('Načteno ' + data.result.numberOfArticlesImported + ' položek katalogu.');
                $('#successdiv').show();
                $('#progress .progress-bar').css('width', '0%');
            },
            fail: function (e, data) {
                $('#error-msg').text('Došlo k chybě. Katalog nebyl načten.');
                $('#errordiv').show();
                $('#progress .progress-bar').css('width', '0%');
            },
            progress: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress .progress-bar').css('width', progress + '%');
            }
        }).prop('disabled', !$.support.fileInput)
                .parent().addClass($.support.fileInput ? undefined : 'disabled');
    });

    function updateRuleButtons() {
        var count = $('#rule-list').children('.ui-selected').size();
        if (count == 1) {
            $('#rename-rule-dlg-btn').removeAttr('disabled');
            $('#delete-rule-dlg-btn').removeAttr('disabled');
        } else {
            $('#rename-rule-dlg-btn').attr('disabled', 'disabled');
            $('#delete-rule-dlg-btn').attr('disabled', 'disabled');
        }
    }

    function showErrorDlg(message) {
        $('#dialog-message').attr({"title":"Chyba!"});
        $('#dialog-message > p').text(message);
        $('#dialog-message').dialog('open');
    }

    function setRuleRank(id, rank) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/' + id + '/rank/' + rank,
            contentType: 'application/json; charset=utf-8',
            data: null,
            error: function ($xhr) {
                $('#dialog-message').attr({"title":"Chyba!"});
                $('#dialog-message > p').text($xhr.responseJSON[0].desc);
                $('#dialog-message').dialog('open');
                loadRules()
            }
        });
    }

    function loadRules() {
        $.ajax({
            type: 'GET',
            url: '/api/v1/rules',
            dataType: 'json',
            success: function (data) {
                $('#rule-list').html('');
                data.forEach(function(rule) {
                    var deleteBtnId = '#btnDeleteRule' + rule.id;
                    $('#rule-list').append('<li id="itemRule' + rule.id + '" ruleId="' + rule.id + '" class="list-group-item"><span class="handle"><span class="glyphicon glyphicon-resize-vertical"></span></span>' + rule.name +
                            '<span id="' + deleteBtnId + '" class="btn btn-danger btn-xs remove-button glyphicon glyphicon-remove" onclick="deleteRule(' + rule.id + ')"></span></li>')
                    $(deleteBtnId).click(function(e) {
                        deleteRule(rule.id);
                    })
                })
            },
            error: function (data) {
                alert('chyba');
            }
        });
    }

    function createRule(ruleName) {
        $.ajax({
            type: 'POST',
            url: '/api/v1/rules',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({'name': ruleName}),
            success: function(data) {
                loadRules();
            },
            error: function ($xhr) {
                showErrorDlg($xhr.responseJSON[0].desc);
                loadRules();
            }
        });
    }

    function renameRule(id, ruleName) {
        $.ajax({
            type: 'PUT',
            url: '/api/v1/rules/' + id,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({'name': ruleName}),
            success: function(data) {
                loadRules();
            },
            error: function ($xhr) {
                showErrorDlg($xhr.responseJSON[0].desc);
                loadRules();
            }
        });
    }

    function deleteRule(id) {
        $.ajax({
            type: 'DELETE',
            url: '/api/v1/rules/' + id,
            success: function(data) {
                loadRules();
            },
            error: function ($xhr) {
                showErrorDlg($xhr.responseJSON[0].desc);
                loadRules();
            }
        });
    }

    loadRules();
</script>
</body>
</html>